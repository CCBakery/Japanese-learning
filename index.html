<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Againï¼ˆOPï¼‰å¬æ­Œå­¦æ—¥è¯­ Â· Romaji + ä¸­æ–‡</title>
<style>
  :root { --bg:#0f1115; --card:#171a21; --muted:#9aa3af; --text:#e5e7eb; --brand:#60a5fa; }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto;
  }
  header{
    padding:12px 16px;
    border-bottom:1px solid #222;
    display:flex;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
  }
  header h1{font-size:16px;margin:0;font-weight:600}
  .wrap{
    display:grid;
    grid-template-columns:1.3fr 1fr;
    gap:12px;
    padding:12px;
    min-height:calc(100vh - 54px);
  }
  .panel{
    background:var(--card);
    border:1px solid #222;
    border-radius:14px;
    padding:12px;
    overflow:auto;
  }
  .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  button,.chip{
    background:#1f2430;
    border:1px solid #2a2f3a;
    color:var(--text);
    padding:8px 10px;
    border-radius:10px;
    cursor:pointer;
  }
  button:hover,.chip:hover{border-color:#3a4252}
  .chip{font-size:12px}
  #current{font-size:20px;font-weight:700;margin:6px 0}
  #romaji{font-size:18px}
  #cn{color:var(--muted)}
  .seg{
    padding:8px;
    border-radius:10px;
    margin:6px 0;
    border:1px solid #232833;
    cursor:pointer;
  }
  .seg:hover{border-color:#374151}
  .active{
    border-color:var(--brand);
    box-shadow:0 0 0 1px color-mix(in srgb, var(--brand) 50%, transparent);
  }
  .small{font-size:12px;color:var(--muted)}
  @media (max-width:900px){
    .wrap{grid-template-columns:1fr}
  }
  .word{
    padding:2px 4px;
    border-radius:6px;
    cursor:pointer;
  }
  .word-active{
    background:rgba(96, 165, 250, 0.25);
    box-shadow:0 0 0 1px rgba(96, 165, 250, 0.4);
  }

  /* å³ä¾§æ­Œè¯ panelï¼šä¸ŠåŠéƒ¨åˆ†å›ºå®šï¼Œä¸‹åŠéƒ¨åˆ†åˆ—è¡¨æ»šåŠ¨ */
  .panel-lyrics{
    display:flex;
    flex-direction:column;
    max-height:calc(100vh - 80px);
    overflow:hidden;
  }
  .panel-lyrics > *:not(#list){
    flex-shrink:0;
  }
  #list{
    flex:1;
    overflow-y:auto;
    margin-top:4px;
    padding-right:4px;
  }
  .seg > div { display: block; }
  .mode-active {
  border-color: var(--brand) !important;
  box-shadow: 0 0 0 1px color-mix(in srgb, var(--brand) 60%, transparent);
  background: rgba(96,165,250,0.12);
}

</style>
</head>
<body>
  <header>
    <h1>Againï¼ˆOPï¼‰å¬æ­Œå­¦æ—¥è¯­ Â· Romaji + ä¸­æ–‡</h1>
    <span class="small">ç©ºæ ¼ï¼šæ’­æ”¾/æš‚åœ Â· â†‘/â†“ï¼šä¸Šä¸€å¥/ä¸‹ä¸€å¥</span>
  </header>

  <div class="wrap">
    <!-- å·¦ï¼šæœ¬åœ°è§†é¢‘ï¼ˆä¸ index.html åŒç›®å½•ï¼‰ -->
    <section class="panel">
      <video id="player" controls style="aspect-ratio:16/9;width:100%;border-radius:8px;display:block">
        <source src="videoplayback.mp4" type="video/mp4">
        Your browser does not support HTML5 video.
      </video>

      <div class="row" style="margin-top:8px">
        <button id="play">â–¶ï¸/â¸</button>
        <button id="prev">â†‘ ä¸Šä¸€å¥</button>
        <button id="next">â†“ ä¸‹ä¸€å¥</button>
      </div>
      <div class="small" style="margin-top:6px">
        å³ä¾§åˆ—è¡¨å¯ç‚¹å‡»è·³è½¬ã€‚
      </div>
    </section>

    <!-- å³ï¼šå½“å‰å¥ + åˆ—è¡¨ -->
    <section class="panel panel-lyrics">
      <div class="small">å½“å‰å¥</div>
      <div id="current"></div>
      <div id="romaji"></div>
      <div id="cn"></div>
      <div class="row" style="margin-top:8px">
        <button id="toggleGrammar" class="chip">å±•å¼€å¥å¼è§£é‡Š</button>
        <button id="toggleRomaji" class="chip">éšè—ç½—é©¬éŸ³</button>
        <button id="startCardMode">è¯å¡æ¨¡å¼</button>
      </div>
      <div id="grammar" class="small" style="margin-top:4px; display:none"></div>
      <hr style="border:0;border-top:1px solid #232833;margin:10px 0">
      <div class="small">å¥å­åˆ—è¡¨ï¼ˆå¯ç‚¹å‡»è·³è½¬ï¼‰</div>
      <div id="list"></div>
    </section>
  </div>

  <script>
    // ====== æ—¥è¯­æœ—è¯»å·¥å…· ======
    let jaVoice = null;

    function initJaVoice() {
      if (!('speechSynthesis' in window)) return;
      const voices = speechSynthesis.getVoices();
      jaVoice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('ja')) || null;
    }

    if ('speechSynthesis' in window) {
      initJaVoice();
      window.speechSynthesis.onvoiceschanged = initJaVoice;
    }

    function speakJa(text) {
      if (!('speechSynthesis' in window)) {
        console.warn('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ speechSynthesis');
        return;
      }
      if (!text) return;

      const u = new SpeechSynthesisUtterance(text);
      u.lang = (jaVoice && jaVoice.lang) || 'ja-JP';
      if (jaVoice) u.voice = jaVoice;
      u.rate = 1.0;
      u.pitch = 1.0;

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }
  </script>

  <!-- é€»è¾‘ï¼ˆHTML5 video ç‰ˆæœ¬ï¼‰ -->
  <script type="module">
    import { SEGMENTS } from "./segments.js";
    window.SEGMENTS = SEGMENTS;

    const video = document.getElementById('player');
    let curIndex = -1;
    let grammarVisible = false;
    let showRomaji = true;
    let quizMode = "order";

    const $ = id => document.getElementById(id);
    function fmtTime(s){
      const m = Math.floor(s/60);
      const sec = (s%60).toFixed(2).padStart(5,'0');
      return `${m}:${sec}`;
    }

    function makeWordLine(parts, clsPrefix) {
      if (!parts) return '';
      return parts
        .map((w, i) =>
          `<span class="word ${clsPrefix}-word" data-word="${i}">${w}</span>`
        )
        .join(' ');
    }

    function renderGrammar(cur) {
      const box = $('grammar');
      if (!box) return;
      if (!cur || !cur.grammar) {
        box.innerHTML = '';
        return;
      }
      box.innerHTML = cur.grammar.replace(/\n/g, '<br>');
    }

    function renderCurrent(){
      const cur = SEGMENTS[curIndex];
      if (!cur) {
        $('current').textContent = '--';
        $('romaji').textContent = '';
        $('cn').textContent = '';
        renderGrammar(null);
        return;
      }

      $('current').innerHTML = makeWordLine(cur.jpParts, 'jp');
      $('romaji').innerHTML = showRomaji
        ? makeWordLine(cur.romajiParts, 'romaji')
        : '';
      // ä¸­æ–‡å§‹ç»ˆæ˜¾ç¤ºï¼ˆå·²ç§»é™¤â€œæ˜¾ç¤º/éšè—ä¸­æ–‡â€åŠŸèƒ½ï¼‰
      $('cn').innerHTML = makeWordLine(cur.zhParts, 'zh');

      renderGrammar(cur);
    }

    let activeWordIndex = null;

    function clearWordHighlight() {
      document
        .querySelectorAll('.word-active')
        .forEach(el => el.classList.remove('word-active'));
      activeWordIndex = null;
    }

    function highlightWord(idx) {
      clearWordHighlight();
      if (idx == null) return;
      activeWordIndex = idx;
      document
        .querySelectorAll(`.word[data-word="${idx}"]`)
        .forEach(el => el.classList.add('word-active'));
    }

    ['current','romaji','cn'].forEach(id => {
      const box = $(id);

      box.addEventListener('mouseover', e => {
        const span = e.target.closest('.word');
        if (!span) return;
        const idx = span.dataset.word;
        highlightWord(idx);
      });

      box.addEventListener('mouseleave', () => {
        if (activeWordIndex == null) clearWordHighlight();
      });

      box.addEventListener('click', e => {
        const span = e.target.closest('.word');
        if (!span) return;
        const idx = span.dataset.word;
        const idxNum = Number(idx);

        if (activeWordIndex === idx) {
          clearWordHighlight();
        } else {
          highlightWord(idx);
        }

        const cur = SEGMENTS[curIndex];
        if (cur && cur.jpParts && cur.jpParts[idxNum]) {
          speakJa(cur.jpParts[idxNum]);
        }
      });
    });

    function highlight(i){
      document.querySelectorAll('.seg').forEach(el=>el.classList.remove('active'));
      if(i>=0){
        const el = document.querySelector(`.seg[data-index="${i}"]`);
        if(el){
          el.classList.add('active');
          el.scrollIntoView({block:'nearest'});
        }
      }
    }

    function buildList() {
      const wrap = $('list');
      wrap.innerHTML = '';

      SEGMENTS.forEach((s, i) => {
        const d = document.createElement('div');
        d.className = 'seg';
        d.dataset.index = i;

        const jpLine  = s.jpParts.join('');
        const romLine = s.romajiParts.join(' ');
        const zhLine  = s.zhSentence || s.zhParts.join('');

        const jpDiv = document.createElement('div');
        jpDiv.innerHTML = `<strong>${jpLine}</strong>`;
        d.appendChild(jpDiv);

        if (showRomaji) {
          const romDiv = document.createElement('div');
          romDiv.className = 'small list-romaji';
          romDiv.textContent = romLine;
          d.appendChild(romDiv);
        }

        const zhDiv = document.createElement('div');
        zhDiv.className = 'small';
        zhDiv.textContent = `${zhLine} Â· ${fmtTime(s.start)} â€“ ${fmtTime(s.end)}`;
        d.appendChild(zhDiv);

        d.onclick = () => jumpTo(i);
        wrap.appendChild(d);
      });
    }

    function jumpTo(i){
      const s = SEGMENTS[i];
      if (!s) return;

      video.pause();
      video.currentTime = s.start;
      setTimeout(() => video.play(), 50);
    }

    function buildCardPool() {
        const pool = [];
        for (const seg of SEGMENTS) {
            if (seg.keyWords) {
                for (const kw of seg.keyWords) pool.push(kw);
            }
        }
        return pool;
    }
    const cardPool = buildCardPool();
    // ========== è¯å¡æ¨¡å¼ï¼šé€‰æ‹©é¢˜å¼•æ“ ==========

    // Fisher-Yates æ´—ç‰Œ
    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function makeQuestion(word, pool) {
      const correct = word.surface;

      // å¹²æ‰°é¡¹ï¼ˆéšæœºæŠ½ä¸¤ä¸ªä¸åŒçš„ï¼‰
      const distractors = shuffle(
        pool.filter(w => w.surface !== correct)
      ).slice(0, 2);

      const options = shuffle([
        correct,
        distractors[0].surface,
        distractors[1].surface
      ]);

      return { zh: word.zh, surface: correct, options };
    }

    function startQuiz(pool) {
      const cardUI = document.getElementById("cardMode");
      const qProgress = document.getElementById("quizProgress");
      const qQuestion = document.getElementById("quizQuestion");
      const qOptions = document.getElementById("quizOptions");
      const qNext = document.getElementById("quizNext");
      const qFeedback = document.getElementById("quizFeedback");

      cardUI.style.display = "block";
      let index = 0;

      const questions =
        (quizMode === "random") 
        ? shuffle(pool)
        : pool;  // é¡ºåºæ¨¡å¼

      function render() {
        const word = questions[index];
        const q = makeQuestion(word, pool);

        qProgress.textContent = `${index + 1} / ${questions.length}`;
        qQuestion.textContent = `â€œ${q.zh}â€ å¯¹åº”çš„æ—¥è¯­è¯æ˜¯ï¼Ÿ`;
        qFeedback.textContent = ""; // æ¸…é™¤ä¸Šä¸€é¢˜çš„æç¤º

        qOptions.innerHTML = "";
        q.options.forEach(op => {
          const btn = document.createElement("button");
          btn.className = "chip";
          btn.textContent = op;

          btn.onclick = () => {
            speakJa(op); // æœ—è¯»é€‰é¡¹

            if (op === q.surface) {
              btn.style.borderColor = "lime";
              qFeedback.style.color = "lime";
              qFeedback.textContent = "âœ” æ­£ç¡®ï¼";
            } else {
              btn.style.borderColor = "crimson";
              qFeedback.style.color = "crimson";
              qFeedback.textContent = "âœ˜ ä¸å¯¹ï¼Œå†è¯•è¯•~";
            }
          };

          qOptions.appendChild(btn);
        });

        qNext.onclick = () => {
          index++;
          if (index >= questions.length) {
            qQuestion.textContent = "ğŸ‰ å…¨éƒ¨å®Œæˆï¼";
            qOptions.innerHTML = "";
            qFeedback.textContent = "";
            qNext.style.display = "none";
            return;
          }
          render();
        };
      }

      qNext.style.display = "inline-block";
      render();
      } 

    // æ—¶é—´é©±åŠ¨ï¼šHTML5 video çš„ timeupdate äº‹ä»¶
    video.addEventListener('timeupdate', ()=>{
      const t = video.currentTime;
      const i = SEGMENTS.findIndex(s => t>=s.start && t<s.end);
      if(i !== curIndex){
        curIndex = i;
        renderCurrent();
        highlight(i);
      }
    });

    const grammarBox = $('grammar');
    const toggleGrammarBtn = $('toggleGrammar');

    if (toggleGrammarBtn && grammarBox) {
      toggleGrammarBtn.onclick = () => {
        grammarVisible = !grammarVisible;
        grammarBox.style.display = grammarVisible ? 'block' : 'none';
        toggleGrammarBtn.textContent = grammarVisible ? 'æ”¶èµ·å¥å¼è§£é‡Š' : 'å±•å¼€å¥å¼è§£é‡Š';
      };
    }

    $('play').onclick = ()=> video.paused ? video.play() : video.pause();
    $('prev').onclick = ()=> jumpTo(Math.max(0, (curIndex>0 ? curIndex-1 : 0)));
    $('next').onclick = ()=> jumpTo(Math.min(SEGMENTS.length-1, (curIndex>=0 ? curIndex+1 : 0)));

    // åˆ‡æ¢ç½—é©¬éŸ³
    $('toggleRomaji').onclick = () => {
      showRomaji = !showRomaji;
      $('toggleRomaji').textContent = showRomaji ? 'éšè—ç½—é©¬éŸ³' : 'æ˜¾ç¤ºç½—é©¬éŸ³';
      renderCurrent();
      buildList();
    };

    // é”®ç›˜ï¼šä»…ä¿ç•™ ç©ºæ ¼ / â†‘ / â†“
    document.addEventListener('keydown', e=>{
      if(e.code==='Space'){
        e.preventDefault();
        $('play').click();
      }
      if(e.key==='ArrowUp'){ $('prev').click(); }
      if(e.key==='ArrowDown'){ $('next').click(); }
    });

    document.getElementById("startCardMode").onclick = () => {
      const pool = buildCardPool();   // ä½ åˆšå†™çš„å‡½æ•°
      startQuiz(pool);                // ä¸‹ä¸€æ­¥æˆ‘ä¼šå¸®ä½ å®ç°
    };
    // é€€å‡ºè¯å¡æ¨¡å¼æŒ‰é’®
    
    const btnOrder = document.getElementById("cardModeOrder");
    const btnRandom = document.getElementById("cardModeRandom");

    function updateModeButtons() {
      if (quizMode === "order") {
        btnOrder.classList.add("mode-active");
        btnRandom.classList.remove("mode-active");
      } else {
        btnRandom.classList.add("mode-active");
        btnOrder.classList.remove("mode-active");
      }
    }

    btnOrder.onclick = () => {
      quizMode = "order";
      updateModeButtons();
    };

    btnRandom.onclick = () => {
      quizMode = "random";
      updateModeButtons();
    };

    // åˆå§‹åŒ–é»˜è®¤çŠ¶æ€ï¼ˆé»˜è®¤é¡ºåºæ¨¡å¼ï¼‰
    updateModeButtons();


    document.getElementById("quizClose").onclick = () => {
      document.getElementById("cardMode").style.display = "none";
    };


    // åˆå§‹åŒ–
    buildList();
    renderCurrent();
  </script>
  <div id="cardMode" style="
  position: fixed;
  inset: 0;
  background: rgba(15,17,21,0.96);
  color: var(--text);
  display: none;
  padding: 24px;
  overflow-y: auto;
  z-index: 9999;
">
  <div style="display:flex; gap:10px; margin-bottom:16px">
    <button id="cardModeOrder" class="chip">é¡ºåºæ¨¡å¼</button>
    <button id="cardModeRandom" class="chip">éšæœºæ¨¡å¼</button>
  </div>
  <div id="quizProgress" style="margin-bottom:12px;font-size:14px;color:var(--muted)"></div>
  <div id="quizQuestion" style="font-size:20px;font-weight:600;margin:16px 0"></div>
  <div id="quizFeedback" style="margin:10px 0;font-size:16px;"></div>
  <div id="quizOptions" style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px"></div>
  <button id="quizNext" class="chip" style="margin-top:10px">ä¸‹ä¸€é¢˜</button>
  <button id="quizClose" class="chip" style="margin-top:10px;background:#333">é€€å‡ºè¯å¡æ¨¡å¼</button>
</div>
</body>
</html>
